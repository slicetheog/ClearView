<Window x:Class="ClearView.UI.LauncherWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:logic="clr-namespace:ClearView.Logic"
        xmlns:data="clr-namespace:ClearView.Data"
        xmlns:viewModel="clr-namespace:ClearView.ViewModel"
        Title="ClearView" Width="600"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        WindowStartupLocation="CenterScreen" ShowInTaskbar="False"
        SizeToContent="Height"
        Loaded="Window_Loaded"
        Deactivated="Window_Deactivated"
        Closing="Window_Closing">

    <Window.DataContext>
        <viewModel:LauncherViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <logic:IconConverter x:Key="IconConverter"/>
            <logic:ActionButtonsVisibilityConverter x:Key="ActionButtonsVisibilityConverter"/>
            <logic:DeleteButtonVisibilityConverter x:Key="DeleteButtonVisibilityConverter"/>
            <logic:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

            <DataTemplate x:Key="DefaultResultTemplate" DataType="{x:Type data:SearchResult}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Image Source="{Binding Converter={StaticResource IconConverter}}" Width="32" Height="32" Margin="0,0,12,0" VerticalAlignment="Center"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontSize="16" Foreground="White"/>
                        <TextBlock Text="{Binding FullPath}" VerticalAlignment="Center" FontSize="11" Opacity="0.7" TextTrimming="CharacterEllipsis">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="Gray"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}, Path=IsSelected}" Value="True">
                                            <Setter Property="Foreground" Value="White"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsSpecialCommand}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right">
                        <StackPanel Orientation="Horizontal">
                            <StackPanel.Visibility>
                                <MultiBinding Converter="{StaticResource ActionButtonsVisibilityConverter}">
                                    <Binding RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type ListBoxItem}}" Path="IsSelected"/>
                                    <Binding Path="IsSpecialCommand"/>
                                    <Binding Path="Type"/>
                                </MultiBinding>
                            </StackPanel.Visibility>
                            <Button Content="🛡" ToolTip="Run as Administrator" Click="RunAsAdmin_Click" Style="{StaticResource ActionButton}" Padding="5" Width="25" Height="25" Margin="5,0,0,0" VerticalContentAlignment="Center"/>
                            <Button Content="📂" ToolTip="Open File Location" Click="OpenFileLocation_Click" Style="{StaticResource ActionButton}" Padding="5" Width="25" Height="25" Margin="5,0,0,0" VerticalContentAlignment="Center"/>
                        </StackPanel>
                        <Button Content="✕" ToolTip="Remove from recent" Click="DeleteRecentItem_Click" Style="{StaticResource ActionButton}" Padding="5" Width="25" Height="25" Margin="10,0,0,0" VerticalContentAlignment="Center">
                            <Button.Visibility>
                                <MultiBinding Converter="{StaticResource DeleteButtonVisibilityConverter}">
                                    <Binding ElementName="SearchBox" Path="Text"/>
                                    <Binding Path="IsSpecialCommand"/>
                                </MultiBinding>
                            </Button.Visibility>
                        </Button>
                    </StackPanel>
                </Grid>
            </DataTemplate>
            
            <DataTemplate x:Key="CalculatorResultTemplate">
                <TextBlock Text="{Binding Name}" Foreground="White" FontSize="28" HorizontalAlignment="Right" Margin="10"/>
            </DataTemplate>

            <DataTemplate x:Key="WebSearchResultTemplate" DataType="{x:Type data:SearchResult}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Image Source="{Binding Converter={StaticResource IconConverter}}" Width="32" Height="32" Margin="0,0,12,0" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" FontSize="16" Foreground="White"/>
                </Grid>
            </DataTemplate>
        </ResourceDictionary>
    </Window.Resources>

    <Border CornerRadius="12" Background="#CC2D2D2D" MouseLeftButtonDown="Window_MouseLeftButtonDown" MouseLeftButtonUp="Window_MouseLeftButtonUp">
        <Grid>
            <StackPanel Margin="10">
                <Border CornerRadius="8" Background="#4A4A4A" Padding="5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Image Source="/Assets/search_icon.png" Width="24" Height="24" VerticalAlignment="Center" Margin="5,0"/>
                        <TextBox x:Name="SearchBox" Grid.Column="1"
                                 FontSize="24"
                                 Background="Transparent"
                                 Foreground="White"
                                 BorderThickness="0"
                                 CaretBrush="White"
                                 TextChanged="SearchBox_TextChanged" 
                                 GotFocus="SearchBox_GotFocus" LostFocus="SearchBox_LostFocus"
                                 PreviewKeyDown="SearchBox_PreviewKeyDown" />
                    </Grid>
                </Border>

                <ListBox x:Name="ResultsBox" Margin="0,5,0,0" MaxHeight="450"
                         Background="Transparent" BorderThickness="0"
                         ItemsSource="{Binding GroupedResults}" 
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         MouseDoubleClick="ResultsBox_MouseDoubleClick">
                    
                    <ListBox.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.HeaderTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" Foreground="White" FontSize="12" Opacity="0.6" Margin="5,8,0,2"/>
                                </DataTemplate>
                            </GroupStyle.HeaderTemplate>
                            <GroupStyle.ContainerStyle>
                                <Style TargetType="{x:Type GroupItem}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ItemCount}" Value="0">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </GroupStyle.ContainerStyle>
                        </GroupStyle>
                    </ListBox.GroupStyle>
                    
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Bd" CornerRadius="8" Background="Transparent" Padding="8" Margin="0,2">
                                            <ContentPresenter />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#007AFF"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Style>
                                    <Style TargetType="ContentControl">
                                        <Setter Property="ContentTemplate" Value="{StaticResource DefaultResultTemplate}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Type}" Value="Calculator">
                                                <Setter Property="ContentTemplate" Value="{StaticResource CalculatorResultTemplate}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Type}" Value="WebSearch">
                                                <Setter Property="ContentTemplate" Value="{StaticResource WebSearchResultTemplate}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Type}" Value="Url">
                                                <Setter Property="ContentTemplate" Value="{StaticResource WebSearchResultTemplate}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ContentControl.Style>
                            </ContentControl>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <StackPanel x:Name="IndexingPanel" VerticalAlignment="Center" HorizontalAlignment="Stretch" Margin="0,15,0,15" 
                            Visibility="{Binding IsIndexingInProgress, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock x:Name="IndexingTitleText" Text="Indexing Files..." Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,8"
                               Visibility="{Binding ShowIndexingTitle, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <TextBlock x:Name="LoadingTitleText" Text="Loading index from cache..." Foreground="White" HorizontalAlignment="Center" Margin="0,0,0,8" 
                               Visibility="{Binding ShowLoadingTitle, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <TextBlock x:Name="IndexingStatusText" Text="{Binding IndexingStatusText}" HorizontalAlignment="Center" Foreground="Gray" FontSize="12"/>
                </StackPanel>
            </StackPanel>
        </Grid>
    </Border>
</Window>